timeout: 10800s
substitutions:
  _DNS: "blank"
steps:

  # [Kick off Terraform deployment]
- name: "gcr.io/cloud-builders/gcloud"
  id: "deploy-cluster"
  dir: "setup"
  args:
  - "builds"
  - "submit"

  # [Build Dyson Container Image]
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/dyson:latest','.']
  id: 'build-image'
  waitFor: ['-']

  # [Push Container Image to gcr]
- name: 'gcr.io/cloud-builders/docker'
  args: ["push", "gcr.io/$PROJECT_ID/dyson:latest",]
  id: 'push-image'
  waitFor: ['build-image']
  
 # Deploy Manifests
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['builds', 'submit', '--config=cloudbuild_soltrades.yaml']
  waitFor: ['push-image', 'deploy-cluster']
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['builds', 'submit', '--config=cloudbuild_ethtrades.yaml']
  waitFor: ['push-image', 'deploy-cluster']
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['builds', 'submit', '--config=cloudbuild_btctrades.yaml']
  waitFor: ['push-image', 'deploy-cluster']
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['builds', 'submit', '--config=cloudbuild_btc.yaml']
  waitFor: ['push-image', 'deploy-cluster']
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['builds', 'submit', '--config=cloudbuild_sol.yaml']
  waitFor: ['push-image', 'deploy-cluster']
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['builds', 'submit', '--config=cloudbuild_eth.yaml']
  waitFor: ['push-image', 'deploy-cluster']

  # [Configure and Deploy Ingress]
- name: gcr.io/kpt-dev/kpt:latest
  id: "set-url"
  args: ['cfg', 'set', '.', 'DNS', '${_DNS}']

- name: 'gcr.io/cloud-builders/kubectl'
  args: ['apply', '-f', './ingress.yaml']
  waitFor: ['push-image', 'deploy-cluster']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-east4'
  - 'CLOUDSDK_CONTAINER_CLUSTER=ftx-ticker-btc-usd-cluster'
